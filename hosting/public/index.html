<!-- report-disaster/hosting/index.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Report Disasters — Auth & Notifications</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Inter, Arial; max-width:760px; margin:18px auto; padding:18px; }
    input, button { padding:8px; margin:6px 0; width:100%; }
    .hint { font-size:13px; color:#555; }
    #status { margin-top:12px; font-weight:bold; }
  </style>
</head>
<body>
  <h2>Report Disasters — Sign in & enable notifications</h2>
  <p class="hint">Login or register to receive push notifications. Optionally share your location.</p>

  <label>Email</label>
  <input id="email" placeholder="you@example.com" />
  <label>Password</label>
  <input id="password" type="password" placeholder="password" />

  <div style="display:flex;gap:8px;margin-top:6px;">
    <button id="signin" style="flex:1;">Sign in</button>
    <button id="register" style="flex:1;">Register</button>
  </div>

  <div style="margin-top:12px;">
    <label><input type="checkbox" id="shareLocation"> Share my location</label>
    <div id="loc"></div>
  </div>

  <div style="margin-top:12px;">
    <button id="enablePush">Enable notifications</button>
  </div>

  <div id="status"></div>

  <!-- Firebase JS SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCcfgV1aIVFAFLsXrKarFTT3hTarsIy8ao",
      authDomain: "report-disasters.firebaseapp.com",
      projectId: "report-disasters",
      storageBucket: "report-disasters.firebasestorage.app",
      messagingSenderId: "194910232971",
      appId: "1:194910232971:web:bf7aacf7ed7dbf73f68f8e",
      measurementId: "G-N19ZTE6961"
    };
    const VAPID_PUBLIC_KEY = "BGowQert-uPDmiMt_JRhRQxXYOD1MYGAu3a4YngUt_UcGIb2a90okhcrbz2T4Ve0qycgrXrq09GP-twZfg8r4a8";

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const messaging = firebase.messaging();

    let currentUser = null;
    let lastLat = null, lastLng = null;

    function setStatus(msg) { document.getElementById('status').innerText = msg; }

    // ---------------- Login / Register ----------------
    document.getElementById('register').onclick = async () => {
      try {
        const res = await auth.createUserWithEmailAndPassword(
          document.getElementById('email').value,
          document.getElementById('password').value
        );
        currentUser = res.user;
        setStatus("Registered & signed in: " + currentUser.email);
      } catch(e) { setStatus("Register error: " + e.message); }
    };

    document.getElementById('signin').onclick = async () => {
      try {
        const res = await auth.signInWithEmailAndPassword(
          document.getElementById('email').value,
          document.getElementById('password').value
        );
        currentUser = res.user;
        setStatus("Signed in: " + currentUser.email);
      } catch(e) { setStatus("Sign-in error: " + e.message); }
    };

    // ---------------- Location ----------------
    async function getLocation() {
      if (!navigator.geolocation) return null;
      return new Promise(res => navigator.geolocation.getCurrentPosition(
        pos => res(pos.coords),
        () => res(null),
        { enableHighAccuracy:true }
      ));
    }

    // ---------------- Push ----------------
    async function enablePush() {
      if (!currentUser) { setStatus("Sign in first."); return; }

      try {
        // optional location
        if (document.getElementById('shareLocation').checked) {
          const coords = await getLocation();
          if (coords) { lastLat = coords.latitude; lastLng = coords.longitude; }
        }

        // register SW and get FCM token
        const reg = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
        const token = await messaging.getToken({ vapidKey: VAPID_PUBLIC_KEY, serviceWorkerRegistration: reg });

        // save token & optional location to Firestore
        const docRef = db.collection("deviceTokens").doc(currentUser.uid);
        const data = { token, email: currentUser.email, updated: firebase.firestore.FieldValue.serverTimestamp() };
        if (lastLat && lastLng) data.lastLocation = new firebase.firestore.GeoPoint(lastLat, lastLng);
        await docRef.set(data, { merge: true });

        setStatus("Notifications enabled! Token saved.");
      } catch(e) { setStatus("Push setup error: " + e.message); }
    }

    document.getElementById('enablePush').onclick = enablePush;

    auth.onAuthStateChanged(u => { if(u) currentUser = u; });
  </script>
</body>
</html>
